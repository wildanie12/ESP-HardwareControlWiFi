<!doctype html>
<html>
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <img src="Laboratorium Elektronika daya.gif"  width="100%">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-toggle.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="fontawesome-free-5.14.0-web/css/all.min.css">
    <title>BAB I : SINGLE PULSE MID-POINT CIRCUIT</title>
</head>
<body style="background-color: #F1F1F1">
    
    <div class="container mt-4">
        <div class="card-header bg-primary">
        	<h3 class="card-title mb-0 text-white text-center">BAB I : SINGLE PULSE MID-POINT CIRCUIT</h3>
        </div>
    </div>
    <div class="container mt-2">
        <div class="card">
            <div class="card-header bg-warning text-black">
            	<h5 class="mb-0">Tujuan Percobaan</h5>
            </div>
            <div class="card-body">
            	<ul>
            		<li>Mengetahui prinsip rangkaian penyearah setengah gelombang</li>
            		<li>Mengetahui prinsip kerja dioda dan SCR</li>
            		<li>Mengetahui pengaruh <i>freewheeling diode</i> pada rangkaian</li>
            		<li>Menganalisis gelombang tegangan dan arus pada beban R dan R-L</li>
            		<li>Mengetahui pengaruh beban L terhadap rangkaian</li>
            	</ul>
            </div>
        </div>
    </div>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-warning text-black">
                <h5 class="mb-0">Rangkaian Utama Percobaan</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                    	<img src="modulawal.png" width="90%" style="display: block; margin: auto;">
                    </div>
                </div>
                <div class="row">
                    <div class="col text-center align-items-center justify-content-center flex-column d-flex" style="height: 320px; background-color: #ddd">
                        <h4 class="mb-0 text-dark" style="font-family: consolas">Camera feed here</h4>
                        <p class="font-italic">Bisa via stream IP Webcam, misal: rtsp://192.168.1.19</p>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col text-center">
                        <div class="reconnecting-element col-12 w-100 h-100 align-items-center justify-content-center" style="position: absolute; background: #F1F1F1; z-index: 1; opacity: 0.8; height: 100%; width: 100%; top: 0; left: 0;">
                            <h4>Reconnecting...</h4>
                        </div>
                        <form id="form-servo">
                            <div class="form-group">
                                <label class="font-weight-bold">Scroll untuk memutar kamera</label>
                                <input type="range" id="servo-slider" class="form-control" min="-90" max="90"/>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-success font-weight-bold" id="btn-servo-kiri">
                                    <i class="fas fa-arrow-left"></i>
                                    Putar ke Kiri
                                </button>
                                <button class="btn btn-success font-weight-bold" id="btn-servo-kanan">
                                    Putar ke Kanan
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-warning">
                <h4 class="card-title mb-0">Kontrol Relay</h4>
                <span class="font-italic" style="font-size: 11pt">silahkan klik beberapa relay sesuai dengan rangkaian percobaan</span>
            </div>
            <div class="card-body d-flex">
                <div class="reconnecting-element col-12 w-100 h-100 align-items-center justify-content-center" style="position: absolute; background: #F1F1F1; z-index: 1; opacity: 0.8; height: 100%; width: 100%; top: 0; left: 0;">
                    <h4>Reconnecting...</h4>
                </div>
                <div class="row">
                    <div class="col-12">
                        <form id="form-relay">
                            <div class="form-group justify-content-center d-flex flex-wrap">
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="1 On" data-off="1 OFF" value="1">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="2 On" data-off="2 OFF" value="2">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="3 On" data-off="3 OFF" value="3">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="4 ON" data-off="4 OFF" value="4">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="5 On" data-off="5 OFF" value="5">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="6 On" data-off="6 OFF" value="6">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="7 On" data-off="7 OFF" value="7">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="8 On" data-off="8 OFF" value="8">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="9 On" data-off="9 OFF" value="9">
                                    <label class="form-check-label"></label>
                                </div>
                                <div class="form-check form-check-inline mb-2">
                                    <input class="form-check-input switch-pin" type="checkbox" data-toggle="toggle" data-on="10 On" data-off="10 OFF" value="10">
                                    <label class="form-check-label"></label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container mt-4">
        <div class="card">
            <div class="card-header bg-warning">
                <h4 class="card-title mb-0">Daftar Percobaan / Eksperimen</h4>
            </div>
            <div class="card-body text-center">
                <div class="row pr-4 pl-4 pb-4 pt-2">
                    <div class="col">
                        <h5>Percobaan 1: Uncontrolled Single Pulse</h5>
                        <img width="90%" src="modul1.png">
                    </div>
                </div>
                <div class="row pr-4 pl-4 pb-4 pt-2" style="background-color: #dedede">
                    <div class="col">
                        <h5>Percobaan 2: Controlled Single Pulse</h5>
                        <img width="90%" src="modul2.png">
                    </div>
                </div>
                <div class="row pr-4 pl-4 pb-4 pt-2">
                    <div class="col">
                        <h5>Percobaan 3: Controlled Single Pulse R-L Load</h5>
                        <img width="90%" src="modul345.png">
                    </div>
                </div>
                <div class="row pr-4 pl-4 pb-4 pt-2" style="background-color: #dedede">
                    <div class="col">
                        <h5>Percobaan 4: Effect of Snubber Circuit</h5>
                        <img width="90%" src="modul345.png">
                    </div>
                </div>
                <div class="row pr-4 pl-4 pb-4 pt-2">
                    <div class="col">
                        <h5>Percobaan 5: Response of Controlled Single Pulse Mid Point with Free Wheeling Diode</h5>
                        <img width="90%" src="modul345.png">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container mt-4 mb-4">
        <footer class="card bg-dark text-light">
            <div class="card-body text-center">
                Copyright 2021 &copy Teknik Elektro Universitas Brawijaya;
            </div>
        </footer> 
    </div>
	

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-toggle.min.js"></script>
    <script type="text/javascript">
    	$(document).ready(function(){

            var hostServer = '10.0.0.19';
            var wsPortServer = '81';
            $(".reconnecting-element").css('display', 'flex');
            function connectWebsocket() {
                ws = new WebSocket('ws://' + hostServer + ':' + wsPortServer + '/', ['arduino']);
                ws.onopen = function() {
                    console.log('Websocket opened');
                    $("#form-relay :input, #form-relay button").prop('disabled', false);

                    $(".reconnecting-element h4").html('Connected!');
                    setTimeout(() => {
                        $(".reconnecting-element").hide('fast');
                    }, 300);

                    ws.send("requestInitialCondition");
                };
                ws.onerror = function(error) {
                    console.log('Websocket error', error);
                };
                ws.onmessage = function(message) {
                    if (IsJsonString(message.data)) {
                        jsonReceive = $.parseJSON(message.data);
                        if (jsonReceive.mode == 'digitalWrite') {
                            jsonReceive.data.forEach((item, index) => {
                                toggleState = '';
                                if (item == 1) toggleState = 'on';
                                else toggleState = 'off';
                                $('.switch-pin').off('change');
                                $('.switch-pin[value=' + index + ']').bootstrapToggle(toggleState);
                                $('.switch-pin').on('change', onChangeSwitchPin()); 
                            })
                        }        
                        else if (jsonReceive.mode == 'servoWrite') {
                            angle = 180 - 90 - jsonReceive.angle;
                            currentServoValue = angle;
                            $("#servo-slider").val(angle);
                        }                
                    }

                }
                ws.onclose = function() {
                    $("#form-relay :input, #form-relay button").prop('disabled', true);
                    $(".reconnecting-element h4").html('Reconnecting...');
                    $(".reconnecting-element").css('display', 'flex');
                    console.log('Websocket closing...');
                    console.log('Reconnecting...');
                    setTimeout(() => {
                        connectWebsocket();
                    }, 1000);
                }
            }
            connectWebsocket();

            /* -------------------------------------------------------------------
             * Switch Websocket
             * ------------------------------------------------------------------- */
            function onChangeSwitchPin() {
                $('.switch-pin').change(function(e) {
                    pin = $(this).val();
                    state = this.checked ? 1 : 0;
                    jsonSend = {
                        operationMode: 'digitalWrite',
                        pin: pin,
                        state: state
                    }
                    ws.send(JSON.stringify(jsonSend));
                });
            }
            onChangeSwitchPin();


            /* -------------------------------------------------------------------
             * Servo Websocket
             * ------------------------------------------------------------------- */
            var currentServoValue = 0;
            setInterval(function() {
                servoValue = $('#servo-slider').val();
                if (servoValue != currentServoValue) {
                    // console.log('val: ' + servoValue);
                    
                    /* Servo yang dikirim via websocket ke ESP ditambahi offset 90 dan dibalik arahnya, 
                     * karena Angle servo tidak bisa minus dan putarannya tidak searah jarum jam */
                    servoValueOffset = 180 - (parseInt(servoValue) + 90);
                    
                    jsonSend = {
                        operationMode: 'servoWrite',
                        pin: 0,
                        angle: servoValueOffset
                    }
                    ws.send(JSON.stringify(jsonSend));
                    currentServoValue = servoValue;
                }
            }, 100);
            $("#btn-servo-kanan").click(function(e) {
                e.preventDefault();
                servoValue = $('#servo-slider').val();
                servoValueAdded = parseInt(servoValue) + 5;
                if (servoValueAdded <= $('#servo-slider').attr('max')) {
                    $('#servo-slider').val(servoValueAdded);
                }
                console.log($('#servo-slider').val())
            });
            $("#btn-servo-kiri").click(function(e) {
                e.preventDefault();
                servoValue = $('#servo-slider').val();
                servoValueAdded = parseInt(servoValue) - 5;
                if (servoValueAdded >= $('#servo-slider').attr('min')) {
                    $('#servo-slider').val(servoValueAdded);
                }
                console.log($('#servo-slider').val())
            });

            /* -------------------------------------------------------------------
             * Utility Only
             * ------------------------------------------------------------------- */
            function IsJsonString(str) {
                try {
                    JSON.parse(str);
                } catch (e) {
                    return false;
                }
                return true;
            }
        });
    </script>
	

</body>
</html>